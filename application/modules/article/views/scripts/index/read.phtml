<?php if (!is_null($this->article)) { ?>    <?php $this->headTitle($this->escape($this->article['title'])); ?>    <?php $filter = new Zend_Filter_StripTags();    $descriptionText = $filter->filter($this->article['header']); ?>    <?php $this->headMeta()->setName('description', $this->escape($descriptionText)); ?>    <?php if (is_array($this->article) && array_key_exists('tags', $this->article) && count($this->article['tags']) > 0) {                $keywordsArray = array();                foreach($this->article['tags'] as $tag) {            if (!empty($tag['name'])) {                $keywordsArray[] = $this->escape($tag['name']);            }        }                if (count($keywordsArray) > 0) {            $this->headMeta()->setName('keywords', implode(', ', $keywordsArray));        }            } ?>    <article role="article" itemscope itemtype="http://schema.org/Article">        <header>            <h1 itemprop="name"><?php echo $this->escape($this->article['title']); ?></h1>            <?php if (is_array($this->article) && array_key_exists('image', $this->article) && !empty($this->article['image'])) { ?>                <?php if (array_key_exists('image_alt', $this->article) && !empty($this->article['image_alt'])) { ?>                    <?php $altAttribute = 'alt="'.$this->escape($this->article['image_alt']).'" '; ?>                <?php } else { ?>                    <?php $altAttribute = ''; ?>                <?php } ?>                <img itemprop="image" src="<?php echo '/upload/images/'.$this->escape($this->article['image']); ?>" <?php echo $altAttribute; ?>/>            <?php } ?>            <?php echo '<div itemprop="description">'.$this->article['header'].'</div>'; ?>        </header>        <div class="clearfix"></div>        <?php if (is_array($this->article) && array_key_exists('body', $this->article)) { ?>            <section itemprop="articleBody">                <?php // conflict with jquery mobile router                //echo $this->domManipulation($this->article['body']); ?>                <?php echo $this->article['body']; ?>            </section>        <?php } ?>        <footer>            <div class="tags_title"><?php echo $this->translate('TAGS').':'; ?></div>            <?php if (is_array($this->article) && array_key_exists('tags', $this->article) && count($this->article['tags']) > 0) { ?>                <?php foreach($this->article['tags'] as $tag) { ?>                    <?php if (!empty($tag['name'])) { ?>                        <a class="btn btn-primary" href="<?php echo $this->url(array('id' => $tag['id']), 'articleindextag'); ?>"><?php echo $this->escape($tag['name']); ?></a>                    <?php } ?>                <?php } ?>            <?php } ?>            <?php if (is_array($this->article) && array_key_exists('relatedArticles', $this->article) && !empty($this->article['relatedArticles'])) { ?>                <div id="related_articles">                    <h4><?php echo $this->translate('RELATED_ARTICLES'); ?></h4>                    <ul>                        <?php foreach($this->article['relatedArticles'] as $relatedArticle) { ?>                            <li><a href="/article/read/<?php echo $relatedArticle['_id']; ?>"><?php echo $relatedArticle['title']; ?></a></li>                        <?php } ?>                    </ul>                </div>            <?php } ?>            <br><br>            <h4><?php echo $this->translate('COMMENTS'); ?></h4>            <?php echo $this->commentForm; ?>            <dialog id="comments">                <?php if (is_object($this->comments)) { ?>                    <ul>                        <?php foreach($this->comments as $comment) { ?>                            <li>                                <?php echo $comment['name'].': '.$comment['comment']; ?>                                <?php $acl = Zend_Registry::get('Acl');                                // TODO: put the role detection into bootstrap or                                // plugin and insert it into session                                $auth = Zend_Auth::getInstance();                                if ($auth->hasIdentity()) {                                    $user = $auth->getIdentity();                                    $role = strtolower($user->role);                                } else {                                    $user = '';                                    $userConfiguration = Zend_Registry::get('UserConfiguration');                                    $defaultRole = $userConfiguration->authentification->default->role;                                    $role = $defaultRole;                                }                                $aclUser = new Chris_Acl_UserRole($user);                                $aclComment = new Chris_Acl_CommentResource($comment);                                //if ($acl->isAllowed($role, 'comment', 'edit')) {                                if ($acl->isAllowed($aclUser, $aclComment, 'edit')) {                                ?>                                    <br>                                    <a class="btn btn-primary" href="<?php echo $this->url(array('id' => (string) $comment['_id'],'article_id' => (string) $this->article['_id']), 'articlecomment'); ?>"><?php echo $this->translate('EDIT'); ?></a>                                <?php } ?>                                <?php if (!empty($role) && $acl->isAllowed($role, 'comment', 'delete')) { ?>                                    <a class="btn btn-primary" href="<?php echo $this->url(array('id' => (string) $comment['_id']), 'deletecomment'); ?>"><?php echo $this->translate('DELETE'); ?></a>                                <?php } ?>                            </li>                        <?php } ?>                    </ul>                <?php } ?>            </dialog>        </footer>    </article><?php } else { ?>    <?php $this->headTitle('404 Not found'); ?>    <h1>Not found <span>:(</span></h1>    <br>    <p>Sorry, but the page you were trying to view does not exist.</p>    <p>It looks like this was the result of either:</p>    <ul>        <li>a mistyped address</li>        <li>an out-of-date link</li>    </ul>    <br><br>    <script type="text/javascript">      var GOOG_FIXURL_LANG = (navigator.language || 'en').slice(0,2);      var GOOG_FIXURL_SITE = 'http://www.chris.lu'    </script>    <script src="//linkhelp.clients.google.com/tbproxy/lh/wm/fixurl.js"></script><?php } ?>